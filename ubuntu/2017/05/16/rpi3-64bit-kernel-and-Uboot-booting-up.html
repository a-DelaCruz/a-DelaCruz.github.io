<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>My Notes on Single Board Computer by </title>
    <link rel="stylesheet" href="/a-DelaCruz.github.io/assets/css/style.css?v=">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  
  <body>
    <div class="wrapper">
      <header>
        <img src="/assets/img/AJ.png"/>
        <h1>My Notes on Single Board Computer</h1>
        <p>Raspberry Pi 3 - 64-Bit kernel and arm64 rootfs
</p>

        

        

        
      </header>
      <section>

      
<div class="top-nav">
  	<nav>
        		<li><a href="/" >Home</a></li>       
	</nav>
</div>
	



<div class="post-org">

	<h2>Raspberry Pi 3 64bit kernel and U-boot booting up</h2>	
	<p class="meta">16 May 2017</p>

	<div class="post">
	  <p>Updated, Organized and corrected some typos:</p>

<h4 id="cross-build-prerequisite"><a href="#header-4"></a>Cross-build prerequisite:</h4>
<div class="highlighter-rouge"><pre class="highlight"><code>gcc-arch64-linux-gnu    g++-5                  ncurses-dev
make                    git                    bc          
u-boot-tools            device-tree-compiler   pkg-config-aarch64-linux-gnu
libncurses5-dev
</code></pre>
</div>
<!--more-->
<p>Assuming there is already a Cross-build environment: Built on Ubuntu Server 16.04.02</p>

<h4 id="prerequisites"><a href="#header-4"></a>Prerequisites:</h4>
<ul>
  <li>Ubuntu Base <a href="http://cdimage.ubuntu.com/ubuntu-base/releases/16.04.2/release/ubuntu-base-16.04.2-base-arm64.tar.gz">Rootfs</a> (install additional package using apt-get)</li>
  <li>Raspberry pi <a href="https://github.com/raspberrypi/linux.git">kernel</a> (Have not tried using Upstream kernel)</li>
  <li>Raspberry pi <a href="https://github.com/raspberrypi/firmware/tree/master/boot">firmware</a>(bootcode.bin, start.elf, fixup.dat as this are the min. files to boot)</li>
  <li><a href="http://www.denx.de/wiki/U-Boot/WebHome">U-boot</a></li>
</ul>

<h4 id="µsd-card-assuming-you-already-know-how-to-partition-it"><a href="#header-4"></a>µSD card: <code class="highlighter-rouge">(assuming you already know how to partition it)</code></h4>

<p>Your µSD card(fat partition 1) should contain the following:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>/boot
bootcode.bin
start.elf 
fixup.dat 
config.txt
cmdline.txt
</code></pre>
</div>
<h6 id="note-boot-sub-folder-will-contain-our-u-boot-file-kernel-and-initrd-image-file"><a href="#header-6"></a>Note: <code class="highlighter-rouge">/boot</code> sub-folder will contain our U-Boot file, Kernel and Initrd image file.</h6>

<p>For the <code class="highlighter-rouge">config.txt</code> and <code class="highlighter-rouge">cmdline.txt</code>, we have to create them and include this lines.</p>

<h5 id="configtxt"><a href="#header-5"></a>config.txt:</h5>
<div class="highlighter-rouge"><pre class="highlight"><code>arm_control=0x200
force_turboo=1
enable_uart=1
device_tree_address=0x100
device_tree_end=0x8000
kernel=boot/kernel8.img
dtparam=i2c_arm=on
dtparam=spi=on
</code></pre>
</div>

<h5 id="cmdlinetxt"><a href="#header-5"></a>cmdline.txt:</h5>
<div class="highlighter-rouge"><pre class="highlight"><code>net.ifnames=0 dwc_otg.lpm_enable=0 console=ttyAMA0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait
</code></pre>
</div>

<h4 id="u-boot"><a href="#header-4"></a>U-Boot:</h4>
<p>Get the source code by cloning the U-Boot git repository or download the tar file.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ git clone depth 1 branch v2017.03 single-branch git://git.denx.de/u-boot.git
</code></pre>
</div>
<p>or download:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>ftp://ftp.denx.de/pub/u-boot/u-boot-2017.03.tar.bz2
</code></pre>
</div>

<p>Then configure and build u-boot. For 64-bit use <code class="highlighter-rouge">rpi_3_defconfig</code></p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ cd u-boot/
$ sudo make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- rpi_3_defconfig
</code></pre>
</div>

<p>Then compile it.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
</code></pre>
</div>

<p>To change output directory use <code class="highlighter-rouge">O=Output path/</code></p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- O=Output path/
</code></pre>
</div>

<p>After it has been built. Locate <code class="highlighter-rouge">u-boot.bin</code> in your output_path as this is the file we need. 
Copy it to your µSD card inside <code class="highlighter-rouge">/boot folder</code> and rename it to <code class="highlighter-rouge">kernel8.img</code> or keep its name as is in config.txt. 
Boot it up to confirm that its working.</p>

<h4 id="kernel"><a href="#header-4"></a>Kernel:</h4>
<p>Get the kernel source code at the official Raspberry pi git repository.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ git clone depth 1 branch v2017.03 single-branch https://github.com/raspberrypi/linux.git
</code></pre>
</div>

<p>Use <code class="highlighter-rouge">bcmrpi3_defconfig</code> for kernel config. 
You can further configure it according to your needs. But for now, its fine to leave it be.
You can also change the output directory using: <code class="highlighter-rouge">O=Output_path/</code></p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ cd linux
$ sudo make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- bcmrpi3_defconfig
$ sudo make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j3
</code></pre>
</div>

<p>Locate <code class="highlighter-rouge">Image</code> (no need to convert for U-Boot use it as it is for 64bit) file at your output_path/ <code class="highlighter-rouge">arch/arm64/boot/</code> 
and the <code class="highlighter-rouge">bcm2710-rpi-3-b.dtb</code> at <code class="highlighter-rouge">arch/arm/boot/dts/</code>. I encounter problem using 
<code class="highlighter-rouge">bcm2837-rpi-3-b.dtb</code>. So for now use <code class="highlighter-rouge">bcm2710-rpi-3-b.dtb</code> instead. 
Copy the <code class="highlighter-rouge">Image</code> in <code class="highlighter-rouge">/boot folder</code> and <code class="highlighter-rouge">bcm2710-rpi-3-b.dtb</code> in the upper most directory of your µSD card.
It should look like this:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>/boot/Image
/boot/kernel8.img
bcm2710-rpi-3-b.dtb
bootcode.bin
start.elf 
fixup.dat 
config.txt
cmdline.txt
</code></pre>
</div>

<p>At this point, you can test it if it will boot the kernel but we need to have a boot script that U-Boot needs. 
Were using the boot.script from this file: <a href="https://www.finnie.org/software/raspberrypi/ubuntu-rpi3/20160517-raspi3-arm64-firmware-kernel.tar.xz"><b>20160517-raspi3-arm64-firmware-kernel.tar.xz</b></a>.</p>

<p>Modify and create the <code class="highlighter-rouge">boot.scr</code> from it.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>$ mkimage -A arm64 -O linux -T script -d /path/to/boot.script /path/where/you/want/to/save
</code></pre>
</div>

<p><code class="highlighter-rouge">boot.script</code> should look like this: and place it inside hte <code class="highlighter-rouge">/boot</code> folder.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>fdt addr 0x100
fdt get value bootargs /chosen bootargs
setenv kernel_addr_r 0x01000000
setenv ramdisk_addr_r 0x02100000
fatload mmc 0:1 ${kernel_addr_r} boot/Image
fatload mmc 0:1 ${ramdisk_addr_r} boot/initrd.img
setenv initrdsize $filesize
fatload mmc 0:1 ${fdt_addr_r} bcm2710-rpi-3-b.dtb
booti ${kernel_addr_r} ${ramdisk_addr_r}:${initrdsize} ${fdt_addr_r}
</code></pre>
</div>

<p>Since we dont have a Ramdisk yet, comment that line and replace <code class="highlighter-rouge">${ramdisk_addr_r}:${initrdsize}</code> with <code class="highlighter-rouge">-</code>.
Or copy the <code class="highlighter-rouge">initrd.img</code> to use it temporarily.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>/boot/Image
/boot/boot.scr
/boot/kernel8.img
/boot/initrd.img
bcm2710-rpi-3-b.dtb
bootcode.bin
start.elf 
fixup.dat 
config.txt
cmdline.txt
</code></pre>
</div>
<p>You can now then verify at this point that our kernel boot as well and will stop at some point 
since we still do not have a filesystem.</p>

<p>Next post will be about on how to make a filesystem base on Ubuntu Base.</p>

<h5 id="reference"><a href="#header-5"></a>Reference:</h5>
<ul>
  <li><a href="https://wiki.ubuntu.com/ARM/RaspberryPi/RaspberryPi3">https://wiki.ubuntu.com/ARM/RaspberryPi/RaspberryPi3</a></li>
  <li><a href="https://wiki.ubuntu.com/Base">https://wiki.ubuntu.com/Base</a></li>
  <li><a href="https://www.raspberrypi.org/documentation/linux/kernel/building.md">https://www.raspberrypi.org/documentation/linux/kernel/building.md</a></li>
  <li><a href="https://kernelnomicon.org/?p=682">https://kernelnomicon.org/?p=682</a></li>
</ul>

<hr />


	</div>

<!-- Comments -->
<div class="comments">
	
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'a-delacruz'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




</div>

</div>


      </section>
      <footer>
        <p><small>Email &mdash; <a href="mailto:delacruzallanjay@gmail.com">Gmail</a></small>
        <small>Wordpress &mdash; <a href="https://cranzblog.wordpress.com">Blog</a></small></p>
      </footer>
    </div>
    <script src="/a-DelaCruz.github.io/assets/js/scale.fix.js"></script>


  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-99256627-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
