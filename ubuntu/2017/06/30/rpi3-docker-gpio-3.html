<!DOCTYPE html>
<html lang="en-US">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>RPi 3: GPIO on .Net Core webApi inside Docker using bcm2835 library: #3</title>

    <link rel="stylesheet" href="/a-DelaCruz.github.io/assets/css/style.css?v=">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="/a-DelaCruz.github.io /assets/img/AJ.png ">
    
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({google_ad_client: "ca-pub-6013311002995151", enable_page_level_ads: true});
    </script>
</head>

    <body>
        <div class="container-body">
            <div class="header brand">
            <img src="/assets/img/AJ.png" />
</div>

<div class="header ads1">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- Ad 2 Horizontal -->
      <ins class="adsbygoogle"
      style="display:inline-block;width:320px;height:50px"
      data-ad-client="ca-pub-6013311002995151"
      data-ad-slot="3839663239"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
</div>

<div class="header ads2">
</div>
        
            <section class="wrapper-body">

            <div class="blog-navi-left">
    <div class="container-navi-left">
    <ul class="navi-left-item">
        <li>
            <a href="/">
                <img class="navi-left" src="/assets/img/home.png" />
            </a>
        </li>
        <li>
            <a href="mailto:delacruzallanjay@gmail.com">
                <img class="navi-left" src="/assets/img/email.png" />
            </a>
        </li>
        <li>
            <a href="https://cranzblog.wordpress.com">
                <img class="navi-left" src="/assets/img/wordpress.png" />
            </a>
        </li>
    </ul>
</div>
</div>
<div class="blog">
    <div class="blog-title">
        <h2>RPi 3: GPIO on .Net Core webApi inside Docker using bcm2835 library: #3</h2>
    </div>
    <div class="blog-date">
        <time>06/30/17</time>
        </div>
    <div class="blog-content">
        <h5 id="17-07-11-the-problem-i-encounter-below-are-fixed-on-the-latest-version-of-net-core">***17-07-11: The problem i encounter below are fixed on the latest version of .Net Core</h5>

<p><br />
In our previous <a href="../27/rpi3-docker-gpio-2">post</a>… we tried a console app. This time we’ll try a web api. So we’ll create a new project and named it <code class="highlighter-rouge">testWebApi</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;dotnet new piwebapi -n testWebApi
</code></pre></div></div>

<p>Above code runned in  windows cmd prompt because i use visual studio code as my editor. Run <code class="highlighter-rouge">dotnet new --help</code> to see a list of available templates.
Now Open the created <code class="highlighter-rouge">/ControllersValuesController</code> and rename it in my case to <code class="highlighter-rouge">TestpinController</code> or just leave it as it is.
we’ll modify our code like so:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

using System.Runtime.InteropServices;

namespace testWebApi.Controllers
{
    [Route("[controller]")]
    public class TestpinController : Controller
    {
        private static uint HIGH = 0x1;
        private static uint LOW  = 0x0;
        private static byte BCM2835_GPIO_FSEL_OUTP = 0x01;
        private static byte RPI_GPIO_P1_07 = 4;

        [DllImport("libbcm2835.so")]
        public static extern int bcm2835_init();

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_close();

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_delay(uint millis);

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_gpio_fsel(byte pin, byte mode);

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_gpio_write(byte pin, uint on);

        [DllImport("libc.so.6")]
        public static extern int geteuid();

        [HttpGet]
        public IEnumerable&lt;string&gt; Get()
        {
            return new string[] { "value1", "value2" };
        }

        [HttpPost]
        public void SwitchPin(int pinId)
        {
            if(bcm2835_init() == pinId)
                bcm2835_gpio_fsel(RPI_GPIO_P1_07, BCM2835_GPIO_FSEL_OUTP);

            switch (pinId)
            {
                case 1:
                    bcm2835_gpio_write(RPI_GPIO_P1_07, HIGH);
                    break;
                case 0:
                    bcm2835_gpio_write(RPI_GPIO_P1_07, LOW);
                    break;
                default:
                    break;
            }

            bcm2835_close();
        }
        
    }
   
}
</code></pre></div></div>

<p>Just like before let’s build and publish it for ubuntu.16.04-arm. Then copy it to our RPi3;</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testWebApi&gt;dotnet build .
testWebApi&gt;dotnet publish -r ubuntu.16.04-arm
</code></pre></div></div>

<p>So when we run it now inside our docker… and browse it at <code class="highlighter-rouge">http://192.168.254.102:5000/Testpin</code> we’ll have an output:
<img src="/ubuntu/images/testWebApi.jpg" alt="" /></p>

<p><br />
But we have no way of sending value <code class="highlighter-rouge">[HttpPost]</code> to our RPi3. For that i use <code class="highlighter-rouge">Postman</code> which is a Chrome extension app for testing Web Apis.</p>

<p><br />
When we send <code class="highlighter-rouge">Get</code> command using <code class="highlighter-rouge">Postman</code> we’ll have an output like these: Displaying the values when we use a WebBrowser.
<img src="/ubuntu/images/Postman-Get.jpg" alt="" /></p>

<p><br />
In order to send a value to our Rpi3… Well use <code class="highlighter-rouge">POST</code> then click <code class="highlighter-rouge">Params</code> right before <code class="highlighter-rouge">SEND</code>. On the <code class="highlighter-rouge">key</code> column type <code class="highlighter-rouge">pinId</code> and a <code class="highlighter-rouge">Value</code> of <code class="highlighter-rouge">1</code> for HIGH[led on] and <code class="highlighter-rouge">0</code> for LOW[led off]. On our first <code class="highlighter-rouge">Send</code>…our RPi3 will complain a <code class="highlighter-rouge">fail</code> and <code class="highlighter-rouge">Postman</code> <code class="highlighter-rouge">Status:500 Internal Server Error</code>. for now i don’t know how to fixe this.
<img src="/ubuntu/images/Postman-Post-1.jpg" alt="" /></p>

<p><br />
But if we press <code class="highlighter-rouge">Send</code> again…. it works, our led is light up and and a <code class="highlighter-rouge">Status:200 OK</code> in <code class="highlighter-rouge">Postman</code>.
<img src="/ubuntu/images/Postman-Post-2.jpg" alt="" /></p>

<p><br />
On to <a href="../../07/01/rpi3-docker-gpio-4">part4</a></p>

<hr />



        <!-- Comments -->
        <div class="comments">
            
    <!-- Add Disqus comments. -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'a-delacruz'; // required: replace example with your forum shortname
        // var disqus_developer = 1; // Comment out when the site is live
        var disqus_identifier = "/ubuntu/2017/06/30/rpi3-docker-gpio-3.html";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the
        <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by
        <span class="logo-disqus">Disqus</span>
    </a>

        </div>
    </div>
</div>

            </section>

            <script src="/a-DelaCruz.github.io/assets/js/scale.fix.js"></script>
            
            <!-- Google Analytics -->
            
                <script>
                    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
                    ga('create', 'UA-99256627-1', 'auto');
                    ga('send', 'pageview');
                </script>
            
        </div>        
    </body>
    
</html>