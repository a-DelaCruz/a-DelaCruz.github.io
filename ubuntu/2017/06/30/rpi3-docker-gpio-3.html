<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>RPi 3: GPIO on .Net Core webApi inside Docker using bcm2835 library: #3</title>

    <link rel="stylesheet" href="/a-DelaCruz.github.io/assets/css/style.css?v=">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="/a-DelaCruz.github.io /assets/img/AJ.png ">
    
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

    <body>
        <div class="wrapper-header">
    <div>
        <img class="logo" src="/assets/img/AJ.png" />
    </div>
</div>
        <div class="wrapper-navi-left">
    <div class="navi-left-list">
        <ul class="navi-left-item">
            <li>
                <a href="/">
                    <img class="navi-left" src="/assets/img/home.png" />
                </a>
            </li>
            <li>
                <a href="mailto:delacruzallanjay@gmail.com">
                    <img class="navi-left" src="/assets/img/email.png" />
                </a>
            </li>
            <li>
                <a href="https://cranzblog.wordpress.com">
                    <img class="navi-left" src="/assets/img/wordpress.png" />
                </a>
            </li>
        </ul>
    </div>
</div>
        <main>
            
            <article class="article-content">
                <div class="wrapper-blog">
    <div class="blog-title">
        <h2>RPi 3: GPIO on .Net Core webApi inside Docker using bcm2835 library: #3</h2>
    </div>
    <div class="blog-date">
        <time>Jun 30, 17</time>
    </div>
    <div class="blog-content">
        <h5 id="17-07-11-the-problem-i-encounter-below-are-fixed-on-the-latest-version-of-net-core">***17-07-11: The problem i encounter below are fixed on the latest version of .Net Core</h5>

<p><br />
In our previous <a href="../27/rpi3-docker-gpio-2">post</a>… we tried a console app. This time we’ll try a web api. So we’ll create a new project and named it <code class="highlighter-rouge">testWebApi</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;dotnet new piwebapi -n testWebApi
</code></pre></div></div>

<p>Above code runned in  windows cmd prompt because i use visual studio code as my editor. Run <code class="highlighter-rouge">dotnet new --help</code> to see a list of available templates.
Now Open the created <code class="highlighter-rouge">/ControllersValuesController</code> and rename it in my case to <code class="highlighter-rouge">TestpinController</code> or just leave it as it is.
we’ll modify our code like so:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

using System.Runtime.InteropServices;

namespace testWebApi.Controllers
{
    [Route("[controller]")]
    public class TestpinController : Controller
    {
        private static uint HIGH = 0x1;
        private static uint LOW  = 0x0;
        private static byte BCM2835_GPIO_FSEL_OUTP = 0x01;
        private static byte RPI_GPIO_P1_07 = 4;

        [DllImport("libbcm2835.so")]
        public static extern int bcm2835_init();

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_close();

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_delay(uint millis);

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_gpio_fsel(byte pin, byte mode);

        [DllImport("libbcm2835.so")]
        public static extern void bcm2835_gpio_write(byte pin, uint on);

        [DllImport("libc.so.6")]
        public static extern int geteuid();

        [HttpGet]
        public IEnumerable&lt;string&gt; Get()
        {
            return new string[] { "value1", "value2" };
        }

        [HttpPost]
        public void SwitchPin(int pinId)
        {
            if(bcm2835_init() == pinId)
                bcm2835_gpio_fsel(RPI_GPIO_P1_07, BCM2835_GPIO_FSEL_OUTP);

            switch (pinId)
            {
                case 1:
                    bcm2835_gpio_write(RPI_GPIO_P1_07, HIGH);
                    break;
                case 0:
                    bcm2835_gpio_write(RPI_GPIO_P1_07, LOW);
                    break;
                default:
                    break;
            }

            bcm2835_close();
        }
        
    }
   
}
</code></pre></div></div>

<p>Just like before let’s build and publish it for ubuntu.16.04-arm. Then copy it to our RPi3;</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testWebApi&gt;dotnet build .
testWebApi&gt;dotnet publish -r ubuntu.16.04-arm
</code></pre></div></div>

<p>So when we run it now inside our docker… and browse it at <code class="highlighter-rouge">http://192.168.254.102:5000/Testpin</code> we’ll have an output:
<img src="/ubuntu/images/testWebApi.jpg" alt="" /></p>

<p><br />
But we have no way of sending value <code class="highlighter-rouge">[HttpPost]</code> to our RPi3. For that i use <code class="highlighter-rouge">Postman</code> which is a Chrome extension app for testing Web Apis.</p>

<p><br />
When we send <code class="highlighter-rouge">Get</code> command using <code class="highlighter-rouge">Postman</code> we’ll have an output like these: Displaying the values when we use a WebBrowser.
<img src="/ubuntu/images/Postman-Get.jpg" alt="" /></p>

<p><br />
In order to send a value to our Rpi3… Well use <code class="highlighter-rouge">POST</code> then click <code class="highlighter-rouge">Params</code> right before <code class="highlighter-rouge">SEND</code>. On the <code class="highlighter-rouge">key</code> column type <code class="highlighter-rouge">pinId</code> and a <code class="highlighter-rouge">Value</code> of <code class="highlighter-rouge">1</code> for HIGH[led on] and <code class="highlighter-rouge">0</code> for LOW[led off]. On our first <code class="highlighter-rouge">Send</code>…our RPi3 will complain a <code class="highlighter-rouge">fail</code> and <code class="highlighter-rouge">Postman</code> <code class="highlighter-rouge">Status:500 Internal Server Error</code>. for now i don’t know how to fixe this.
<img src="/ubuntu/images/Postman-Post-1.jpg" alt="" /></p>

<p><br />
But if we press <code class="highlighter-rouge">Send</code> again…. it works, our led is light up and and a <code class="highlighter-rouge">Status:200 OK</code> in <code class="highlighter-rouge">Postman</code>.
<img src="/ubuntu/images/Postman-Post-2.jpg" alt="" /></p>

<p><br />
On to <a href="../../07/01/rpi3-docker-gpio-4">part4</a></p>

<hr />


    
        <!-- Comments -->
        <div class="comments">
            <!-- Add Disqus comments. -->
<div id="disqus-thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'a-delacruz'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </div>
    </div>
</div>


            </article>
        </main>

        <script src="/a-DelaCruz.github.io/assets/js/scale.fix.js"></script>

        <!-- Google Analytics -->
        <script>
            (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-99256627-1', 'auto');
            ga('send', 'pageview');
        </script>
        
    </body>
    
</html>