<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>RPi 3: GPIO on .Net Core inside Docker using bcm2835 library ported to C#: #4</title>

    <link rel="stylesheet" href="/a-DelaCruz.github.io/assets/css/style.css?v=">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="/a-DelaCruz.github.io /assets/img/AJ.png ">
    
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

    <body>
        <div class="wrapper-header">
    <div>
        <img class="logo" src="/assets/img/AJ.png" />
    </div>
</div>
        <div class="wrapper-navi-left">
    <div class="navi-left-list">
        <ul class="navi-left-item">
            <li>
                <a href="/">
                    <img class="navi-left" src="/assets/img/home.png" />
                </a>
            </li>
            <li>
                <a href="mailto:delacruzallanjay@gmail.com">
                    <img class="navi-left" src="/assets/img/email.png" />
                </a>
            </li>
            <li>
                <a href="https://cranzblog.wordpress.com">
                    <img class="navi-left" src="/assets/img/wordpress.png" />
                </a>
            </li>
        </ul>
    </div>
</div>
        <main>
            
            <article class="article-content">
                <div class="wrapper-blog">
    <div class="blog-title">
        <h2>RPi 3: GPIO on .Net Core inside Docker using bcm2835 library ported to C#: #4</h2>
    </div>
    <div class="blog-date">
        <time>Jul 1, 17</time>
    </div>
    <div class="blog-content">
        <p>Since we now have tested our previous scenarios… Now let’s try to translate bcm2835 library C code to C# and only importing some C functions. That means we only need to have a glibc library present in our system. There are already C# library out there… like:</p>
<ul>
  <li><a href="https://github.com/raspberry-sharp/raspberry-sharp-io">Raspberry# IO</a></li>
  <li><a href="https://github.com/cypherkey/RaspberryPi.Net/">RaspberryPi.Net</a></li>
  <li><a href="https://www.raspberrypi.org/forums/viewtopic.php?f=34&amp;t=152940">BCM2835 port to C#</a></li>
</ul>

<p><br />
Seems fine to use with mono installed… although i never tried to use them. And i have not read all their codes on which part are the Mono part. But there are some imports C function that are common to them. Among those three, the last one is a direct port of BCM2835 library to full C# code. But still use a few Mono system calls. So for now what i did is use his codes <code class="highlighter-rouge">BCM2835 port to C#</code>, remove and modify some of it.
So far this is what i’ve done and still not finished:</p>

<h4 id="some-c-functions">Some C functions.</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
using System.Runtime.InteropServices;

namespace RPi3
{
    public static class Interop
    {

        #region Enum
           
            public enum OpenFlags : int // Open
            {
                O_RDWR = 2,
                O_SYNC = 10000
            }
            
            
            public enum MmapProts : int //mmap
            {
                PROT_READ = 1,  // Page can be read.
                PROT_WRITE = 2,  // Page can be written.
                PROT_EXEC = 4,  // Page can be executed.
                PROT_READWRITE = PROT_READ | PROT_WRITE
            }

            
            public enum MmapFlags : int // mmap
            {
                MAP_SHARED = 1,     // Share changes.
                MAP_PRIVATE = 2     // Changes are private.
            }

            public struct timespec  //Delay under test
            {
                public IntPtr tv_sec; /* seconds */
                public IntPtr tv_nsec; /* nanoseconds */
            }
        #endregion
        
        #region Libc
            [DllImport("libc.so.6")]
            public static extern int geteuid();

            [DllImport("libc.so.6")]
            public static extern int open(string pathname, OpenFlags flags);

            [DllImport("libc.so.6")]
            public static extern int close(int fd);

            [DllImport("libc.so.6")]
            public static extern void sync();

            [DllImport("libc.so.6")]
            public static extern IntPtr mmap(IntPtr addr, uint length, MmapProts prot, MmapFlags flags, int fd, uint offset);

            [DllImport("libc.so.6")]
            public static extern int munmap(IntPtr addr, uint length);

            [DllImport("libc.so.6")]
            public static extern int nanosleep(ref timespec req, ref timespec rem);

        #endregion
    }
}
</code></pre></div></div>

<p>You must include an <code class="highlighter-rouge">EntryPoint</code> on your <code class="highlighter-rouge">DllImport</code> in you ever want to change its name.. like so:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[DllImport("libc.so.6", EntryPoint = "open")]
private static extern IntPtr OpenSename(string pathname, OpenFlags flags);
</code></pre></div></div>

<p>And replace all code that use <code class="highlighter-rouge">Syscall</code> to use this <code class="highlighter-rouge">Interop</code> and remove Mono directive.
I also remove this code below for now: and just use it’s type pointer instead like in the orginal but without having it volatile.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public unsafe struct VolatilePointer
    {
        public volatile uint* Address;

        public VolatilePointer(uint Address)
        {
            this.Address = (uint*)Address;
        }

        public VolatilePointer(uint* Address)
        {
            this.Address = Address;
        }

        public static implicit operator VolatilePointer(uint* Address)
        {
            return new VolatilePointer(Address);
        }

        public static implicit operator VolatilePointer(uint Address)
        {
            return new VolatilePointer(Address);
        }
    }
</code></pre></div></div>

<p>So from these:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[MethodImpl(MethodImplOptions.AggressiveInlining)] // &lt;- I still need more time to grasp what this is for so i removed it for now
public static uint bcm2835_peri_read(VolatilePointer paddr)
{
    uint ret;

    Thread.MemoryBarrier();
    ret = *paddr.Address;
    Thread.MemoryBarrier();
    return ret;
}
</code></pre></div></div>

<p>into these:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static uint bcm2835_peri_read(uint* paddr)
{
    uint ret;

    Thread.MemoryBarrier();
    ret = *paddr;
    Thread.MemoryBarrier();
    return ret;;
}
</code></pre></div></div>
<p>For simple output test these are the basic function that is needed from <a href="https://www.raspberrypi.org/forums/viewtopic.php?f=34&amp;t=152940">BCM2835 port to C#</a>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bcm2835_init()
mapmem
bcm2835_peri_read
bcm2835_peri_write
bcm2835_peri_set_bits
bcm2835_gpio_fsel
bcm2835_gpio_set
bcm2835_gpio_clr
bcm2835_gpio_write
</code></pre></div></div>

<hr />


    
        <!-- Comments -->
        <div class="comments">
            <!-- Add Disqus comments. -->
<div id="disqus-thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'a-delacruz'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </div>
    </div>
</div>


            </article>
        </main>

        <script src="/a-DelaCruz.github.io/assets/js/scale.fix.js"></script>

        <!-- Google Analytics -->
        <script>
            (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-99256627-1', 'auto');
            ga('send', 'pageview');
        </script>
        
    </body>
    
</html>