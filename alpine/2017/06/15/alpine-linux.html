<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>RPi 3 Alpine Linux arm64</title>

    <link rel="stylesheet" href="/a-DelaCruz.github.io/assets/css/style.css?v=">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="/a-DelaCruz.github.io /assets/img/AJ.png ">
    
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

    <body>
        <div class="wrapper-header">
    <div>
        <img class="logo" src="/assets/img/AJ.png" />
    </div>
</div>
        <div class="wrapper-navi-left">
    <div class="navi-left-list">
        <ul class="navi-left-item">
            <li>
                <a href="/">
                    <img class="navi-left" src="/assets/img/home.png" />
                </a>
            </li>
            <li>
                <a href="mailto:delacruzallanjay@gmail.com">
                    <img class="navi-left" src="/assets/img/email.png" />
                </a>
            </li>
            <li>
                <a href="https://cranzblog.wordpress.com">
                    <img class="navi-left" src="/assets/img/wordpress.png" />
                </a>
            </li>
        </ul>
    </div>
</div>
        <main>
            
            <article class="article-content">
                <div class="wrapper-blog">
    <div class="blog-title">
        <h2>RPi 3 Alpine Linux arm64</h2>
    </div>
    <div class="blog-date">
        <time>Jun 15, 17</time>
    </div>
    <div class="blog-content">
        <h4 id="-17-07-06-to-fix-brcmfmac-loading-error-directly-place-brcm-folder-inside-our-custom-initramfs-rpi3-file">*** 17-07-06: To fix brcmfmac loading error: directly place <code class="highlighter-rouge">brcm</code> folder inside our custom <code class="highlighter-rouge">initramfs-rpi3</code> file.</h4>
<h4 id="-17-07-06-b43-in-optional">*** 17-07-06: <code class="highlighter-rouge">b43</code> in optional…</h4>

<p>As i was been busy studying and learning about Docker and how nice it is to use Alpine linux as the docker image because of it being small in size… unlike using ubuntu as a docker image file…This time… i decided to try Alpine linux on Raspberry Pi 3.</p>

<h4 id="prerequisites">Prerequisites:</h4>
<ul>
  <li>Alpine linux Generic Arm - <a href="https://nl.alpinelinux.org/alpine/v3.6/releases/aarch64/alpine-uboot-3.6.1-aarch64.tar.gz">aarch64</a></li>
  <li>For the kernel and U-boot…just follow my previous <a href="rpi3-64bit-kernel-and-Uboot-booting-up">post</a>.</li>
</ul>

<h4 id="note-enable-squashfs-support--file-systems---miscellaneous-filesystems----squashfs-40">Note: Enable Squashfs support @ File systems -&gt; Miscellaneous filesystems -&gt; &lt;*&gt; SquashFS 4.0</h4>

<p>The files that we need from alpine to modify is <code class="highlighter-rouge">initramfs-vanilla</code>, and a copy of <code class="highlighter-rouge">apk</code> folder (<code class="highlighter-rouge">alpine.apkovl.tar.gz</code> is optional). so go ahead and extract them.</p>

<p><code class="highlighter-rouge">initramfs-vanilla</code> is a compressed cpio archive. To extract it we do this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir temp
$ cd temp
$ sudo gunzip -c /boot/initramfs-vanilla | cpio -i
</code></pre></div></div>

<p>Then we need to install our latest modules into it…assuming you already compiled kernel 4.11. following this <a href="rpi3-64bit-kernel-and-Uboot-booting-up">post</a>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- make modules_install INSTALL_MOD_PATH=../temp/
        when it is done go back to /temp/ folder where we extract the initramfs and into the modules folder.
$ cd temp/lib/modules/
        and remove the kernel previous version and optional: the build, source folder symlink in temp/lib/modules/4.11~/ folder
$ sudo rm -rf 4.9~
</code></pre></div></div>

<p>Now we have our custom initramfs and then recreate the compressed cpio archive again.
Inside the folder run:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo find . | cpio -H newc -o | gzip -9 &gt; [file destination]/initramfs-rpi3-cpio
$ cd ..
$ sudo mkimage -A arm64 -O linux -T ramdisk -d initramfs-rpi3-cpio initramfs-rpi3 // For U-boot
</code></pre></div></div>

<p><code class="highlighter-rouge">modloop-vanilla</code> is a squashfs file. We can make from scratch or unsquash it using this command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo unsquashfs -f -d [file destination] [file location]/file.squashfs
</code></pre></div></div>

<p>To create our own <code class="highlighter-rouge">modloop</code> file let start by making a folder</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mkdir modules // Then inside this module, let's install again our rpi-4.11y modules from above
</code></pre></div></div>

<p>After you’ve installed <code class="highlighter-rouge">our modules from above</code> on the modules folder that we’ve just created.. you’ll have a folder structure like so:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/modules
        |- /lib
                |- /firmware    // firmware_install INSTALL_FW_PATH=[in this location or just use from the moodlop-vanilla] 
                |- /modules     // again remove build and source symlink folder here
</code></pre></div></div>

<p>Rearrange above modules folder to:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/modules/modules/firmware
/modules/modules/4.11~
</code></pre></div></div>

<p>Squash it using this command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mksquashfs [folder to be squash] [filename] -comp [compression method: I use 'xz' -Xdict-size 100%
</code></pre></div></div>

<p>And now we have our own <code class="highlighter-rouge">initramfs-rpi3</code> and <code class="highlighter-rouge">modloop-rpi3</code>. Our µsd card should now look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/apk
/boot/Image
/boot/kernel8.img
/boot/boot.scr
/boot/initramfs-rpi3
/boot/modloop-rpi3
bcm2710-rpi-3-b.dtb
bootcode.bin
start.elf 
fixup.dat 
config.txt
cmdline.txt
alpine.apkovl.tar.gz // optional will be created once we setup our alpine linux
</code></pre></div></div>

<p>We’ll modify the <code class="highlighter-rouge">cmdline.txt</code> and <code class="highlighter-rouge">boot.scr</code> for alpine linux.</p>
<h5 id="cmdlinetxt">cmdline.txt</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>modules=loop,squashfs,sd-mod,usb-storage quiet net.ifnames=0 dwc_otg.lpm_enable=0 console=ttyS0,115200 fsck.repair=yes rootwait
// the quiet command can be remove: it just hide the message buffer of kernel. `ttyS0` can be replace by `ttyAMA0`
</code></pre></div></div>

<h5 id="bootscr">boot.scr</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fdt addr 0x100
fdt get value bootargs /chosen bootargs
setenv kernel_addr_r 0x01000000
setenv ramdisk_addr_r 0x02100000
fatload mmc 0:1 ${kernel_addr_r} boot/Image
fatload mmc 0:1 ${ramdisk_addr_r} boot/initramfs-rpi3
setenv initrdsize $filesize
fatload mmc 0:1 ${fdt_addr_r} bcm2710-rpi-3-b.dtb
booti ${kernel_addr_r} ${ramdisk_addr_r}:${initrdsize} ${fdt_addr_r}
</code></pre></div></div>

<p>Go ahead noew and try to boot it up. You should have an output like this:</p>

<p><img src="/alpine/images/alpine-linux-arm64-rpi3.jpg" alt="" /></p>

<p>As you can see… there’s a hwclock error since our raspberry pi 3 don’t have any. So after you run <code class="highlighter-rouge">setup-alpine</code> and use <code class="highlighter-rouge">lbu commit </code> to save changes…run this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># rc-update add swclock boot    # enable the software clock
# rc-update del hwclock boot    # disable the hardware clock
</code></pre></div></div>
<p>In my case i use <code class="highlighter-rouge">Busybox NTP</code> as it might be the most lightweight solution. Save the changes and reboot.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># lbu commit
# apk add wireless-tools wpa_supplicant  // will be installed even when not connected to the net
# reboot
</code></pre></div></div>

<h4 id="wifi-optional">Wifi: (optional…)</h4>
<p>I didn’t include the <code class="highlighter-rouge">brcm</code> above because i encouter a <code class="highlighter-rouge">brcmf_sdio_htclk</code> error but can be resolve by reloading the module: <code class="highlighter-rouge">brcmfmac</code>
The good thing about alpine linux is if you make a <code class="highlighter-rouge">firmware folder</code> on the root directory of our µsd card, it’ll be recognized by alpine and load it once alpine boot up. Don’t worry if the rest of the folder inside the OS fimrware folder is gone(it’s  just hidden in plain site). So i place my brcm folder there for now.</p>

<p>According to alpine linux… <a href="https://wiki.alpinelinux.org/wiki/Connecting_to_a_wireless_access_point">Connecting to a wireless access point</a> Broadcom Wi-Fi Chipset Users: we need <code class="highlighter-rouge">b43-firmware</code> so go ahead and follow that or we can compile it somewhere else like what i did.</p>

<p>On ubuntu 16.04 i install <code class="highlighter-rouge">b43-fwcutter</code> then get <a href="http://mirror2.openwrt.org/sources/broadcom-wl-4.150.10.5.tar.bz2">b43-firmware</a> and follow the instruction <a href="http://linuxwireless.org/en/users/Drivers/b43/">here</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tar -xjf broadcom-wl-4.150.10.5.tar.bz2       // make sure bzip is installed
$ b43-fwcutter -w [$FIRMWARE_INSTALL_DIR/b43] broadcom-wl-4.150.10.5/driver/wl_apsta_mimo.o
</code></pre></div></div>

<p>Then copy that <code class="highlighter-rouge">b43</code> folder to firmware folder on the root of our µsd card.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/apk
/boot/Image
/boot/kernel8.img
/boot/boot.scr
/boot/initramfs-rpi3
/boot/modloop-rpi3
/firmware/b43
/firmware/brcm
bcm2710-rpi-3-b.dtb
bootcode.bin
start.elf 
fixup.dat 
config.txt
cmdline.txt
alpine.apkovl.tar.gz // optional will be created once we setup our alpine linux
</code></pre></div></div>

<p>Load the <code class="highlighter-rouge">b43</code> kernel and enable it at boot up:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ modprobe b43
$ echo b43 &gt;&gt; /etc/modules
$ lbu commit    //To save changes
</code></pre></div></div>

<p>If you run <code class="highlighter-rouge">dmesg</code> command and display a brcmfmac error just reload <code class="highlighter-rouge">brcmfmac module</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ modprobe -r brcmfmac  // For now
$ modprobe brcmfmac
</code></pre></div></div>

<p>Feedback is at most welcome…</p>

<h5 id="reference">Reference:</h5>
<ul>
  <li>http://backreference.org/2010/07/04/modifying-initrdinitramfs-files/</li>
  <li>https://askubuntu.com/questions/437880/extract-a-squashfs-to-an-existing-directory</li>
  <li>https://wiki.alpinelinux.org/wiki/DIY_Fully_working_Alpine_Linux_for_Allwinner_and_Other_ARM_SOCs</li>
  <li>https://wiki.alpinelinux.org/wiki/Raspberry_Pi</li>
</ul>

<hr />


    
        <!-- Comments -->
        <div class="comments">
            <!-- Add Disqus comments. -->
<div id="disqus-thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'a-delacruz'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </div>
    </div>
</div>


            </article>
        </main>

        <script src="/a-DelaCruz.github.io/assets/js/scale.fix.js"></script>

        <!-- Google Analytics -->
        <script>
            (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-99256627-1', 'auto');
            ga('send', 'pageview');
        </script>
        
    </body>
    
</html>