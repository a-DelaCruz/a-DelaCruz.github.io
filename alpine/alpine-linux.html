<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="keywords" content="Raspberry Pi 3 64bit Kernel">

    <title>Raspberry Pi 3 Alpine Linux arm64</title>
    <meta name="description" content="*** 17-07-06: To fix brcmfmac loading error: directly place brcm folder inside our custom initramfs-rpi3 file.*** 17-07-06: b43 in optional…">

    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({google_ad_client: "ca-pub-6013311002995151", enable_page_level_ads: true});
    </script>

    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Raspberry Pi 3 Alpine Linux arm64 | My Personal Notes</title>
<meta property="og:title" content="Raspberry Pi 3 Alpine Linux arm64" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="*** 17-07-06: To fix brcmfmac loading error: directly place brcm folder inside our custom initramfs-rpi3 file. *** 17-07-06: b43 in optional…" />
<meta property="og:description" content="*** 17-07-06: To fix brcmfmac loading error: directly place brcm folder inside our custom initramfs-rpi3 file. *** 17-07-06: b43 in optional…" />
<link rel="canonical" href="http://a-delacruz.github.io/alpine/alpine-linux.html" />
<meta property="og:url" content="http://a-delacruz.github.io/alpine/alpine-linux.html" />
<meta property="og:site_name" content="My Personal Notes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-06-15T00:00:00+08:00" />
<script type="application/ld+json">
{"name":null,"description":"*** 17-07-06: To fix brcmfmac loading error: directly place brcm folder inside our custom initramfs-rpi3 file. *** 17-07-06: b43 in optional…","author":null,"@type":"BlogPosting","url":"http://a-delacruz.github.io/alpine/alpine-linux.html","publisher":null,"image":null,"headline":"Raspberry Pi 3 Alpine Linux arm64","dateModified":"2017-06-15T00:00:00+08:00","datePublished":"2017-06-15T00:00:00+08:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://a-delacruz.github.io/alpine/alpine-linux.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
  
  <body>

    <div class="row">
      <div class="col s2">
        <div class="header">
    <div class="card">
        <div class="card-image">
            <a href="/"><img src="/assets/img/AJ.png"/></a>
        </div>
        <div class="card-action valign-wrapper center-align">
            <a id="aboutBtn" href="#about" class="tooltipped modal-trigger" data-position="bottom" data-delay="30" data-tooltip="About">
              
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 0h24v24H0z" fill="none"/>
        <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
    </svg>

    
            </a>
            <a id="contactBtn" href="#contact" class="tooltipped modal-trigger" data-position="bottom" data-delay="30" data-tooltip="Contact">
              
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
        <path d="M0 0h24v24H0z" fill="none"/>
    </svg>

    
            </a>
        </div>
    </div>
</div>

<!-- Modal Structure -->
<div id="about" class="modal modal-close">
    <div class="modal-content">
        <span class="closeBtn modal-close">&times;</span>
        <h4>About</h4>
        <p>This is a base Jekyll site that i constantly re-design. And a place for sharing what i learned so far on anythng that interest me.</p>
        <p>Some post are temporarily removed for revisions.</p>
         <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Ad 2 Horizontal -->
<ins class="adsbygoogle" style="display:inline-block;width:320px;height:50px" data-ad-client="ca-pub-6013311002995151" data-ad-slot="3839663239"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
    </div>
</div>

<div id="contact" class="modal">
    <div class="modal-content">
        <span class="closeBtn modal-close">&times;</span>
        <h4>Contact</h4>

        <form id="gform" class="col s12" method="POST" action="https://script.google.com/macros/s/AKfycbwWNS9whgt0iDYN7E1ze3AAuTOV4JwKstvsPFai7C8sBi4yOAs7/exec">
            <div class="input-field col s6">
                <input id="last_name" type="text" class="validate" name="name">
                <label>Name</label>
            </div>
            <div class="input-field col s6">
                <input id="email" type="email" class="validate" name="email">
                <label data-error="wrong" data-success="right">Email</label>
            </div>
            <div class="input-field col s12">
                <textarea id="message" class="materialize-textarea" name="message"></textarea>
                <label>Message</label>
            </div>
            <button id="sendBtn" class="btn blue" type="submit" >Send</button>
        </form>
        <!-- Customise the Thankyou Message People See when they submit the form: -->
        <div style="display:none;" id="thankyou_message">
            <h2><em>Thanks</em> for contacting us!
            We will get back to you soon!</h2>
        </div>
        
        <div id="loader-wrapper">
            <div id="loader"></div>
            <div class="loader-section"></div>
        </div>
    </div>
</div>

      </div>
      <div class="ads col s10">
        <!-- bannerA %} -->
      </div>
    </div>
    <div class="row">
      <div class="col s12">
        <section>
          <nav class="fixed-action-btn vertical">
    <a class="btn-floating btn-large red" >
        <i class="large material-icons">more_vert</i>
    </a>
    <ul>
        <li></li>
        <li><a class="btn-floating green tooltipped" data-tooltip="Coming Soon" data-position="left"><i class="material-icons">mode_comment</i></a></li>
        <li><a href="/" class="btn-floating blue"><i class="material-icons">home</i></a></li>
    </ul>
</nav>

<nav class="navi-left">
    <div class="dropdown">
        <a class="btn dropdown-button" data-activates='dropdown1'>
        <i class="large material-icons">more_vert</i>
    </a>
        <div>
        <ul id='dropdown1' class='dropdown-content'>
            
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                            <li>
                                <a href="/alpine/alpine-wifi.html">Raspberry Pi 3 Wifi config</a>
                            </li>
                        
                    
                
                    
                        
                            <li>
                                <a href="/alpine/alpine-linux.html">Raspberry Pi 3 Alpine Linux arm64</a>
                            </li>
                        
                    
                 
                           
            
            </ul>  
        </div>
    </div>
</nav>

       

<div class="container">
    <h3 class="center-align">Raspberry Pi 3 Alpine Linux arm64</h3>

    <div class="posts">
        <h5 id="-17-07-06-to-fix-brcmfmac-loading-error-directly-place-brcm-folder-inside-our-custom-initramfs-rpi3-file">*** 17-07-06: To fix brcmfmac loading error: directly place <code class="highlighter-rouge">brcm</code> folder inside our custom <code class="highlighter-rouge">initramfs-rpi3</code> file.</h5>
<h5 id="-17-07-06-b43-in-optional">*** 17-07-06: <code class="highlighter-rouge">b43</code> in optional…</h5>

<p>As i was been busy studying and learning about Docker and how nice it is to use Alpine linux as the docker image because of it being small in size… unlike using ubuntu as a docker image file…This time… i decided to try Alpine linux on Raspberry Pi 3.</p>

<h2 id="prerequisites">Prerequisites:</h2>
<ul>
  <li>Alpine linux Generic Arm - <a href="https://nl.alpinelinux.org/alpine/v3.6/releases/aarch64/alpine-uboot-3.6.1-aarch64.tar.gz">aarch64</a></li>
  <li>For the kernel and U-boot…just follow <a href="/ubuntu/rpi3-setup-64bit-kernel">Raspberry Pi 3 64-bit kernel</a>.</li>
</ul>

<h5 id="note-enable-squashfs-support--file-systems---miscellaneous-filesystems----squashfs-40">Note: Enable Squashfs support @ File systems -&gt; Miscellaneous filesystems -&gt; &lt;*&gt; SquashFS 4.0</h5>

<p>The files that we need from alpine to modify is <code class="highlighter-rouge">initramfs-vanilla</code>, and a copy of <code class="highlighter-rouge">apk</code> folder (<code class="highlighter-rouge">alpine.apkovl.tar.gz</code> is optional). so go ahead and extract them.</p>

<p><code class="highlighter-rouge">initramfs-vanilla</code> is a compressed cpio archive. To extract it we do this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir temp
$ cd temp
$ sudo gunzip -c /boot/initramfs-vanilla | cpio -i
</code></pre></div></div>

<p>Then we need to install our latest modules into it…assuming you already compiled kernel 4.11. following this <a href="/ubuntu/rpi3-setup-64bit-kernel">Raspberry Pi 3 64-bit kernel</a>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- make modules_install INSTALL_MOD_PATH=../temp/
        when it is done go back to /temp/ folder where we extract the initramfs and into the modules folder.
$ cd temp/lib/modules/
        and remove the kernel previous version and optional: the build, source folder symlink in temp/lib/modules/4.11~/ folder
$ sudo rm -rf 4.9~
</code></pre></div></div>

<p>Now we have our custom initramfs and then recreate the compressed cpio archive again.
Inside the folder run:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo find . | cpio -H newc -o | gzip -9 &gt; [file destination]/initramfs-rpi3-cpio
$ cd ..
$ sudo mkimage -A arm64 -O linux -T ramdisk -d initramfs-rpi3-cpio initramfs-rpi3 // For U-boot
</code></pre></div></div>

<p><code class="highlighter-rouge">modloop-vanilla</code> is a squashfs file. We can make from scratch or unsquash it using this command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo unsquashfs -f -d [file destination] [file location]/file.squashfs
</code></pre></div></div>

<p>To create our own <code class="highlighter-rouge">modloop</code> file let start by making a folder</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mkdir modules // Then inside this module, let's install again our rpi-4.11y modules from above
</code></pre></div></div>

<p>After you’ve installed <code class="highlighter-rouge">our modules from above</code> on the modules folder that we’ve just created.. you’ll have a folder structure like so:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/modules
        |- /lib
                |- /firmware    // firmware_install INSTALL_FW_PATH=[in this location or just use from the moodlop-vanilla] 
                |- /modules     // again remove build and source symlink folder here
</code></pre></div></div>

<p>Rearrange above modules folder to:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/modules/modules/firmware
/modules/modules/4.11~
</code></pre></div></div>

<p>Squash it using this command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mksquashfs [folder to be squash] [filename] -comp [compression method: I use 'xz' -Xdict-size 100%
</code></pre></div></div>

<p>And now we have our own <code class="highlighter-rouge">initramfs-rpi3</code> and <code class="highlighter-rouge">modloop-rpi3</code>. Our µsd card should now look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/apk
/boot/Image
/boot/kernel8.img
/boot/boot.scr
/boot/initramfs-rpi3
/boot/modloop-rpi3
bcm2710-rpi-3-b.dtb
bootcode.bin
start.elf 
fixup.dat 
config.txt
cmdline.txt
alpine.apkovl.tar.gz // optional will be created once we setup our alpine linux
</code></pre></div></div>

<p>We’ll modify the <code class="highlighter-rouge">cmdline.txt</code> and <code class="highlighter-rouge">boot.scr</code> for alpine linux.</p>
<h4 id="cmdlinetxt">cmdline.txt</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>modules=loop,squashfs,sd-mod,usb-storage quiet net.ifnames=0 dwc_otg.lpm_enable=0 console=ttyS0,115200 fsck.repair=yes rootwait
// the quiet command can be remove: it just hide the message buffer of kernel. `ttyS0` can be replace by `ttyAMA0`
</code></pre></div></div>

<h4 id="bootscr">boot.scr</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fdt addr 0x100
fdt get value bootargs /chosen bootargs
setenv kernel_addr_r 0x01000000
setenv ramdisk_addr_r 0x02100000
fatload mmc 0:1 ${kernel_addr_r} boot/Image
fatload mmc 0:1 ${ramdisk_addr_r} boot/initramfs-rpi3
setenv initrdsize $filesize
fatload mmc 0:1 ${fdt_addr_r} bcm2710-rpi-3-b.dtb
booti ${kernel_addr_r} ${ramdisk_addr_r}:${initrdsize} ${fdt_addr_r}
</code></pre></div></div>

<p>Go ahead noew and try to boot it up. You should have an output like this:</p>

<p><img src="/assets/img/alpine/alpine-linux-arm64-rpi3.jpg" alt="" class="materialboxed" /></p>

<p>As you can see… there’s a hwclock error since our raspberry pi 3 don’t have any. So after you run <code class="highlighter-rouge">setup-alpine</code> and use <code class="highlighter-rouge">lbu commit </code> to save changes…run this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># rc-update add swclock boot    # enable the software clock
# rc-update del hwclock boot    # disable the hardware clock
</code></pre></div></div>
<p>In my case i use <code class="highlighter-rouge">Busybox NTP</code> as it might be the most lightweight solution. Save the changes and reboot.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># lbu commit
# apk add wireless-tools wpa_supplicant  // will be installed even when not connected to the net
# reboot
</code></pre></div></div>
<p><br /></p>

<h2 id="wifi-optional">Wifi: (optional…)</h2>

<p>I didn’t include the <code class="highlighter-rouge">brcm</code> above because i encouter a <code class="highlighter-rouge">brcmf_sdio_htclk</code> error but can be resolve by reloading the module: <code class="highlighter-rouge">brcmfmac</code>
The good thing about alpine linux is if you make a <code class="highlighter-rouge">firmware folder</code> on the root directory of our µsd card, it’ll be recognized by alpine and load it once alpine boot up. Don’t worry if the rest of the folder inside the OS fimrware folder is gone(it’s  just hidden in plain site). So i place my brcm folder there for now.</p>

<p>According to alpine linux… <a href="https://wiki.alpinelinux.org/wiki/Connecting_to_a_wireless_access_point">Connecting to a wireless access point</a> Broadcom Wi-Fi Chipset Users: we need <code class="highlighter-rouge">b43-firmware</code> so go ahead and follow that or we can compile it somewhere else like what i did.</p>

<p>On ubuntu 16.04 i install <code class="highlighter-rouge">b43-fwcutter</code> then get <a href="http://mirror2.openwrt.org/sources/broadcom-wl-4.150.10.5.tar.bz2">b43-firmware</a> and follow the instruction <a href="http://linuxwireless.org/en/users/Drivers/b43/">here</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tar -xjf broadcom-wl-4.150.10.5.tar.bz2       // make sure bzip is installed
$ b43-fwcutter -w [$FIRMWARE_INSTALL_DIR/b43] broadcom-wl-4.150.10.5/driver/wl_apsta_mimo.o
</code></pre></div></div>

<p>Then copy that <code class="highlighter-rouge">b43</code> folder to firmware folder on the root of our µsd card.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/apk
/boot/Image
/boot/kernel8.img
/boot/boot.scr
/boot/initramfs-rpi3
/boot/modloop-rpi3
/firmware/b43
/firmware/brcm
bcm2710-rpi-3-b.dtb
bootcode.bin
start.elf 
fixup.dat 
config.txt
cmdline.txt
alpine.apkovl.tar.gz // optional will be created once we setup our alpine linux
</code></pre></div></div>

<p>Load the <code class="highlighter-rouge">b43</code> kernel and enable it at boot up:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ modprobe b43
$ echo b43 &gt;&gt; /etc/modules
$ lbu commit    //To save changes
</code></pre></div></div>

<p>If you run <code class="highlighter-rouge">dmesg</code> command and display a brcmfmac error just reload <code class="highlighter-rouge">brcmfmac module</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ modprobe -r brcmfmac  // For now
$ modprobe brcmfmac
</code></pre></div></div>

<p><br /></p>

<h4 id="reference-">Reference :</h4>

<blockquote>
  <p><a href="http://backreference.org/2010/07/04/modifying-initrdinitramfs-files/">http://backreference.org/2010/07/04/modifying-initrdinitramfs-files/</a><br />
   <a href="https://askubuntu.com/questions/437880/extract-a-squashfs-to-an-existing-directory">https://askubuntu.com/questions/437880/extract-a-squashfs-to-an-existing-directory</a>
   <a href="https://wiki.alpinelinux.org/wiki/DIY_Fully_working_Alpine_Linux_for_Allwinner_and_Other_ARM_SOCs">https://wiki.alpinelinux.org/wiki/DIY_Fully_working_Alpine_Linux_for_Allwinner_and_Other_ARM_SOCs</a><br />
   <a href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi">https://wiki.alpinelinux.org/wiki/Raspberry_Pi</a></p>
</blockquote>

<hr />


        
        <!-- Comments -->
        
            <form method="POST" action="https://api.staticman.net/v2/entry///comments">
    <input name="options[redirect]" type="hidden" value="https://a-DelaCruz.github.io">
    <!-- e.g. "2016-01-02-this-is-a-post" -->
    <input name="options[slug]" type="hidden" value="alpine-linux">
    <label>
        <input name="fields[name]" type="text">Name</label>
    <label>
        <input name="fields[email]" type="email">E-mail</label>
    <label>
        <textarea name="fields[message]"></textarea>Message</label>

    <button type="submit">Go!</button>
</form>
                       
        
        
    </div>
         
</div>
        </section>
      </div>
    </div>  

    <script src="/assets/js/jquery-3.2.1.min.js"></script>
    <script src="/assets/js/materialize.min.js"></script>
    <script src="/assets/js/site.js"></script>

    <!-- Submit the Form to Google Using "AJAX" -->
    <script data-cfasync="false" type="text/javascript"
    src="/assets/js/form-submission-handler.js">
    </script>
    
    <!-- Google Analytics -->
            
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', '', 'auto');
        ga('send', 'pageview');
    </script>
  </body>
</html>